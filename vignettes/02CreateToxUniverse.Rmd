---
title: "Part 2 - Infering the toxicogenomic universe"
author: "Andreas SchÃ¼ttler"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Part 2 - Infering the toxicogenomic universe}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "#>"
)
```

The package `toxprofileR` mainly builds on the packages `limma`, `kohonen` and `hydromad` to supply functions for creating dynamic toxicogenomic fingerprints. The package currently only works with data from Agilent based zebrafish microarrays designed by Oaklabs.
This vignette describes new experimental data in combination with published toxicogenomic data from the ZFE is used to infer a self-organizing map (SOM), here called the "toxicogenomic universe"

## Load logFC data and apply spline smooth

When using machine learning algorithms like the self-organizing map, there is no proper way of dealing with replicates and with interval data. This is why we decided to "use" this knowledge first by applying a spline-smooth on the data before feeding it into the self-organizing map.

Therefore we first load the logFC data (see `Part 1- Loading and preprocessing microarray data` on how to retrieve logFC data from raw microarray data). For each gene and substance, outlier measurements are removed and afterwards a 3D-spline is fit.

```{r smooth data}
library("toxprofileR")
for(substance in c("diuron","diclofenac","naproxen")){
    
    load(file = paste0("./data/",substance,"/data_logfc_",substance,".Rd"))

    assign(x = paste("data",substance,"logFC_smooth",sep = "_"),
           value = toxprofileR::spline_fit(get(paste("data",substance,"logFC",sep = "_"))))
    
    save(list=paste("data",substance,"logFC_smooth",sep = "_"), file = paste0("./data/",substance,"/data_logfc_smooth",substance,".Rd"))
}
```

## Infer self-organizing map

The logFC values which are spine-smoothed now (and do not contain any replicates any longer) are now fed into the SOM-algorithm. We save the resulting list in our project directory

```{r som}

tox_universe <- toxprofileR::create_tox_universe(dslist = list(data_diuron_logFC_smooth,
                                                  data_diclofenac_logFC_smooth,
                                                  data_naproxen_logFC_smooth),
                                    output = T,
                                    seed = 2312)

save(tox_universe, file="./data/all/tox_universe.Rd")
```

### Retrieve nodeframe

The part of the results which we will use most, is the assignment of genes to toxnodes. This is stored in the list entry `nodeframe`. We retrieve and save this as an extra file.

```{r nodeframe}
nodeframe <- tox_universe$nodeframe
save(nodeframe, file="./data/all/universe_nodeframe.Rd")
```

### Retrieve grid

Also often used will be the `grid`. We retrieve and save this as an extra file.

```{r nodeframe}
grid <- tox_universe$som_model$grid
save(grid, file="./data/all/universe_grid.Rd")
```

##Session Info
```{r session info, echo=FALSE}
devtools::session_info()
```
